# vim:fileencoding=utf-8
# License: BSD
# Copyright: 2015, Kovid Goyal <kovid at kovidgoyal.net>

linter = require('../tools/lint.js')

def lint(code):
    return linter.lint_code(code, {filename:'<test>', report:def():
                                   pass
})

def err_test(code, ident, line, name, other_line):
    msgs = lint(code)
    assert.ok(len(msgs) > 0, 'failed to find error in: ' + code)
    assert.equal(len(msgs), 1, 'found ' + (len(msgs) - 1) + ' extra errors in: ' + code)
    assert.equal(msgs[0].ident, ident, 'incorrect ident: ' + msgs[0].ident + ' for: ' + code)
    if line != undefined:
        assert.equal(msgs[0].start_line, line, 'incorrect line: ' + msgs[0].start_line + ' for: ' + code)
    if name != undefined:
        assert.equal(msgs[0].name, name, 'incorrect name: ' + msgs[0].name + ' for: ' + code)
    if other_line != undefined:
        assert.equal(msgs[0].other_line, other_line, 'incorrect other_line: ' + msgs[0].other_line + ' for: ' + code)

def ok_test(code):
    msgs = lint(code)
    assert.equal(msgs.length, 0, 'Got unexpected msg: ' + (msgs[0] or {}).message + ' for code: ' + code)

# Imports
err_test('import foo', 'unused-import', 1, 'foo')
err_test('import foo.boo', 'unused-import', 1, 'foo')
err_test('import foo as boo', 'unused-import', 1, 'boo')
err_test('from x import foo', 'unused-import', 1, 'foo')
err_test('from x import foo as boo', 'unused-import', 1, 'boo')
ok_test('import foo\nfoo')

# Function arguments
ok_test('def f(a):\n return a')
ok_test('def f(a=1):\n return a')
ok_test('def f(*a):\n return a')
ok_test('def f(**a):\n return a')
ok_test('def f(a):\n return 1')

# Top level unused ignored
ok_test('a=1\ndef f():\n pass')

# Destructuring assignment
ok_test('def f():\n a, b = 1, 2; a, b')
ok_test('def f():\n a = 1; b, c = a, 2; return b, c')
err_test('def f():\n a, b = 1, 1; return a', 'unused-local', 2, 'b')

# Compound assignment
err_test('a += 1', 'undef', 1, 'a')
ok_test('def f():\n a = 1; a += 1')

# Unused bindings
err_test('def f():\n a=1', 'unused-local', 2, 'a')
err_test('def f():\n def a():\n  pass', 'unused-local', 2, 'a')

# Undefined references
err_test('f()', 'undef', 1, 'f')
err_test('a', 'undef', 1, 'a')
err_test('def f():\n a=1; return a\na', 'undef', 3, 'a')

# Comprehensions
ok_test('[x for x in [1,2]]')
ok_test('[1 for x in [1,2] if x]')
ok_test('[1 for x in [1,2]]')
err_test('def f():\n [x for x in [1,2]]; return x', 'undef', 2, 'x')

# Loops
ok_test('def f():\n for x in "":\n  pass\n return x')
ok_test('def f():\n for x in "":\n  x += 1\n')
ok_test('def f():\n for x, y in "":\n  pass\n return x, y')
err_test('def f():\n a = 1\n for a in "":\n  a', 'loop-shadowed', 3, 'a', 2)

# Semi-colons
err_test('a=1;;a', 'extra-semicolon', 1, ';')
err_test('a=1;', 'eol-semicolon', 1, ';')

# Builtins
for k in 'String Symbol this self window Map arguments print len range dir undefined'.split(' '):
    ok_test(k)

# noqa
ok_test('f() # noqa')
ok_test('f() # noqa:undef')
err_test('f() # noqa:xxx', 'undef')

# Named func in branch
err_test('if 1:\n def f():\n  pass', 'func-in-branch', 2, 'f')
err_test('if 1:\n pass\nelse:\n def f():\n  pass', 'func-in-branch', 4, 'f')
err_test('try:\n def f():\n  pass\nexcept:\n pass', 'func-in-branch', 2, 'f')
ok_test('if 1:\n a = def():\n  pass')

# Syntax errors
err_test('def f(:\n pass', 'syntax-err', 1)

# Functions
ok_test('def f():\n pass\nf()')

# Non-locals
err_test('def a():\n x = 1\n def b():\n  nonlocal x\n b()', 'unused-local', 2, 'x')
ok_test('def a():\n x = 1\n def b():\n  nonlocal x\n  x\n b()')
ok_test('def a():\n x = 1\n def b():\n  nonlocal x\n  x\n  x = 2\n b()')
ok_test('def a():\n x = 1\n def ():\n  nonlocal x\n  x = 1\n  x')

# Define after use
err_test('def g():\n f()\n f()\n def f():\n  pass', 'def-after-use', 3, 'f')

# Decorators
ok_test('from x import y\n@y\ndef f():\n pass')

# try/except
ok_test('try:\n 1\nexcept Error as e:\n e')

# Classes
ok_test('''
class A:

    def __init__(self, a):
        self.a = a

class B(A):

    def __init__(self):
        A.__init__(self, 'b')
''')
